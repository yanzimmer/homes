[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
loglevel=info

[program:init_db]
directory=/app/Backend-System
command=/bin/sh -c "if [ ! -f /app/Backend-System/sql/.first_run_done ] && [ ! -f /app/Backend-System/sql/hotel.db ]; then /usr/bin/python3 init-scripts/init_hotel_db.py --init --seed-demo-data --create-default-admin; else echo 'Skip DB init: sentinel or DB exists'; fi"
autostart=true
autorestart=false
startsecs=0
priority=10
stdout_logfile=/var/log/supervisor/init_db.log
stderr_logfile=/var/log/supervisor/init_db_err.log

[program:init_notify_config]
directory=/app/Backend-System
command=/bin/sh -c "if [ ! -f /app/Backend-System/sql/.first_run_done ] && [ ! -f /app/Backend-System/config/notification_config.json ]; then /usr/bin/python3 init-scripts/init_notification_config.py; else echo 'Skip notify init: sentinel or config exists'; fi"
autostart=true
autorestart=false
startsecs=0
priority=11
stdout_logfile=/var/log/supervisor/init_notify.log
stderr_logfile=/var/log/supervisor/init_notify_err.log

[program:init_ocr_config]
directory=/app/Backend-System
command=/bin/sh -c "if [ ! -f /app/Backend-System/sql/.first_run_done ] && [ ! -f /app/Backend-System/config/ocr_config.json ]; then /usr/bin/python3 init-scripts/init_ocr_config.py; else echo 'Skip OCR init: sentinel or config exists'; fi"
autostart=true
autorestart=false
startsecs=0
priority=12
stdout_logfile=/var/log/supervisor/init_ocr.log
stderr_logfile=/var/log/supervisor/init_ocr_err.log

[program:mark_first_run]
directory=/app/Backend-System
command=/bin/sh -c "if [ ! -f /app/Backend-System/sql/.first_run_done ] && [ -f /app/Backend-System/sql/hotel.db ] && [ -f /app/Backend-System/config/notification_config.json ] && [ -f /app/Backend-System/config/ocr_config.json ]; then touch /app/Backend-System/sql/.first_run_done; echo 'First run initialization complete'; else echo 'Sentinel already present or prerequisites missing'; fi"
autostart=true
autorestart=false
startsecs=0
priority=13
stdout_logfile=/var/log/supervisor/mark_first_run.log
stderr_logfile=/var/log/supervisor/mark_first_run_err.log

[program:prewarm_ocr]
directory=/app/Backend-System
command=/bin/sh -c "if [ ! -f /app/Backend-System/sql/.first_run_done ]; then /usr/bin/python3 -c 'from paddleocr import PaddleOCR; PaddleOCR(use_angle_cls=True, lang=\"ch\"); print(\"PaddleOCR prewarm done\")' || echo 'PaddleOCR prewarm skipped'; else echo 'Skip prewarm: sentinel present'; fi"
autostart=true
autorestart=false
startsecs=0
priority=14
stdout_logfile=/var/log/supervisor/prewarm_ocr.log
stderr_logfile=/var/log/supervisor/prewarm_ocr_err.log

[program:gunicorn]
directory=/app/Backend-System
command=/bin/sh -c "i=0; while [ ! -f /app/Backend-System/sql/.first_run_done ] && [ $i -lt 60 ]; do echo 'Waiting for first-run init...'; sleep 1; i=$((i+1)); done; /usr/local/bin/gunicorn --preload -w 3 -b 0.0.0.0:5000 app:app"
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
environment=PYTHONUNBUFFERED="1"
priority=20

[program:nginx]
command=/usr/sbin/nginx -g 'daemon off;'
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
priority=30